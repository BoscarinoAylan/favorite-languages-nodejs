<h2>src/middleware/validacao.js</h2>

<pre><code class="lang-js">const { validate } = require('email-validator');
const passwordValidator = require('password-validator');

const validarUsuario = (req, res, next) => {
    const usuario = req.body;

    const { email, senha } = usuario;

    if (!email || !senha) {
        return res.status(400).json({
            error: 'campos email e senha são obrigatórios'
        });
    }

    if (!validate(email)) {
        return res.status(400).json({ error: 'formato de email inválido' });
    }

    return next();
};

const validarSenha = (req, res, next) => {
    const { senha } = req.body;

    const schema = new passwordValidator();

    schema
        .is()
        .min(8)
        .has()
        .lowercase()
        .has()
        .digits()
        .has()
        .not()
        .spaces();

    if (!schema.validate(senha)) {
        return res.status(400).json({ error: 'senha muito fraca' });
    }
    return next();
};

module.exports = { validarUsuario, validarSenha };
</code></pre>

<h3>Visão Geral</h3>

<p>
    Esse módulo é responsável por prover as funções de middleware que irão
    validar dados passados pelo cliente no corpo das requisições garantindo que
    estejam no formato adequado para nossa aplicação.
</p>

<h3>Comentários</h3>

<ul>
    <li>
        <span class="lf-strong">Linha 1</span>: Importamos a função validate da
        dependência email-validator, essa função nos permite validar o formato
        do email sem precisarmos lidar diretamente com expressões regulares.
        <pre><code class="lang-js">const { validate } = require('email-validator');</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 2</span>: Importamos o módulo da
        dependência password-validator que nos irá permitir exigir um formato da
        senha informada pelo cliente no momento de cadastrar um novo usuário.
        Nesse caso iremos exigir que a senha tenha no mínimo 8 dígitos e que
        tenha números e letras minúsculas.
        <pre><code class="lang-js">const passwordValidator = require('password-validator');</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 4</span>: Criamos a função validarUsuario
        que, por se tradar de um middleware, deve ter os parâmetros para a
        requisição, resposta e a função next.
        <pre><code class="lang-js">const validarUsuario = (req, res, next) => {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 5 e 7</span>: Armazenamos os dados
        passados no corpo da requisição na constante de nome usuário, em seguida
        desempacotamos os atributos email e senha de usuario;
        <pre><code class="lang-js">const usuario = req.body;

const { email, senha } = usuario;</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 9 a 13</span>:Criamos uma estrutura
        condicional para verificar se os campos email e senha estão vazios, caso
        estejam retornamos uma resposta com status 400 (bad request) e uma
        mensagem dizendo que os campos são obrigatórios
        <pre><code class="lang-js">if (!email || !senha) {
    return res.status(400).json({
        error: 'campos email e senha são obrigatórios'
    });
}</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 15 e 17</span>: Agora criamos outra
        estrutura condicional para certificarmos que o email é válido, caso não
        seja retornamos uma resposta com status 400 (bad request) e uma mensagem
        dizendo que o formato do e-mail está inválido
        <pre><code class="lang-js">if (!validate(email)) {
    return res.status(400).json({ error: 'formato de email inválido' });
}</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 19</span>: Por fim, caso os dados tenham
        passado nas duas verificações retornaremos a execução da função next()
        para que o próximo middleware no ciclo requisição-resposta retome o
        controle.
        <pre><code class="lang-js">return next();</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 22 e 23</span>: Criamos a função
        validarSenha que, por se tradar de um middleware, deve ter os parâmetros
        para a requisição, resposta e a função next. Em seguida desempacotamos o
        atributo senha do corpo da requisição.
        <pre><code class="lang-js">const validarSenha = (req, res, next) => {
    const { senha } = req.body;</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 25</span>: Instanciamos passwordValidator
        na constante schema para montarmos o esquema de validação do formato da
        senha que será exigida pela nossa aplicação.
        <pre><code class="lang-js">const schema = new passwordValidator();</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 27 a 36</span>: Definimos o esquema de
        validação do formato da senha através da interface fluente do
        password-validator. Nesse caso estamos dizenod que a senha deve ter um
        mínimo de 8 caractares, dentre eles possuir letras mínusculas, números e
        não pode haver espaços.
        <pre><code class="lang-js">schema
    .is()
    .min(8)
    .has()
    .lowercase()
    .has()
    .digits()
    .has()
    .not()
    .spaces();</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 38 a 40</span>: Criamos uma estrutura
        condicional que irá verificar se a senha fornecida pelo cliente está no
        formato que definimos no schema, caso não esteja. retornaremos uma
        resposta com status 400 (bad request) e uma mensagem informando que a
        senha não está adequada.
        <pre><code class="lang-js">if (!schema.validate(senha)) {
    return res.status(400).json({ error: 'senha muito fraca' });
}</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 41</span>: Por fim, caso os dados tenham
        passado pela verificação retornaremos a execução da função next() para
        que o próximo middleware no ciclo requisição-resposta retome o controle.
        <pre><code class="lang-js">return next();</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 44</span>: Exportamos as funções
        validarUsuario e validarSenha para que possam ser usadas em outras
        partes da aplicação.
        <pre><code class="lang-js">module.exports = { validarUsuario, validarSenha };</code></pre>
    </li>
</ul>
