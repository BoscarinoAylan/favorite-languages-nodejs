<h2>src/repository/usuarios.js</h2>

<pre><code class="lang-js">const Usuario = require('../model/Usuario');
const { gerarCredenciais, gerarJWT, senhaConfere } = require('../service/auth');

const cadastrarUsuario = dadosUsuario => {
    return Usuario.find({ email: dadosUsuario.email }).then(data => {
        const usuario = { cadastrado: false };
        if (!data.length) {
            usuario.novo = new Usuario(dadosUsuario);

            const credenciais = gerarCredenciais(dadosUsuario.senha);
            usuario.novo.salt = credenciais.salt;
            usuario.novo.hash = credenciais.hash;
            usuario.token = gerarJWT(
                usuario.novo.id,
                usuario.novo.email,
                usuario.novo.nome
            );
            usuario.novo.save();
            usuario.cadastrado = true;
        }
        return usuario;
    });
};

const logarUsuario = (email, senha) => {
    return Usuario.findOne({ email }).then(cadastrado => {
        const usuario = { autenticado: false };
        if (cadastrado && senhaConfere(senha, cadastrado)) {
            usuario.token = gerarJWT(
                cadastrado.id,
                cadastrado.email,
                cadastrado.nome
            );
            usuario.autenticado = true;
        }
        return usuario;
    });
};

module.exports = { cadastrarUsuario, logarUsuario };
</code></pre>

<h3>Visão Geral</h3>

<p>
    Este módulo é responsável por fornecer uma camada de abstração da entidade
    de usuários para a aplicação. Esta entidade tem como propósito cadastrar
    novos usuários e permitir que usuários existentes sejam autenticados na API
    através do método JSON Web Token.
</p>

<h3>Comentários</h3>

<ul>
    <li>
        <span class="lf-strong">Linhas 1 e 2</span>: Fazemos a importação do
        objeto modelo Usuário através do qual poderemos realizar ações de
        escrita e leitura no banco de dados. Importamos também as funções
        gerarCredenciais, gerarJWT, senhaConfere do módulo de serviço de
        autenticação da aplicação.
        <pre><code class="lang-js">const Usuario = require('../model/Usuario');
const { gerarCredenciais, gerarJWT, senhaConfere } = require('../service/auth');
</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 4</span>: Criamos a função
        cadastrarUsuario que irá receber os dados usuários como parâmetro e
        retornar o usuário cadastrado.
        <pre><code class="lang-js">const cadastrarUsuario = dadosUsuario => {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 5 </span>: A primeira coisa que
        precisamos fazer para cadastrar um usuário é ter certeza que seu e-mail
        já não está sendo usado. Para isso iremos retornar o método
        Usuario.find() indicando que queremos recuperar todos os usuários que
        possuirem o campo email igual ao ao atributo email de dadosUsuario. Como
        find() retorna uma promise iremos executar seu then() passando-lhe uma
        função callback que terá o resultado da busca em seu parâmetro.
        <pre><code class="lang-js">return Usuario.find({ email: dadosUsuario.email }).then(data => {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 6</span>: Criamos a constante usuario que
        armazena um objeto com o atributo cadastrado igual a false. Esse objeto
        será o retorno da função cadastrarUsuario e irá informar quem a executou
        se o usuário passado foi cadastrado ou não.
        <pre><code class="lang-js">const usuario = { cadastrado: false };</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 7</span>: Verificamos se a lista
        recuperada pelo método find possui elementos, caso ela não possua um
        length (tamanho) significa que não foram encontrados usuários com aquele
        e-mail cadastrado
        <pre><code class="lang-js">if (!data.length) {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 8</span>: Criamos o atributo usuario.novo
        que irá receber uma nova instância do modelo Usuario utilizando os dados
        que foram passados à função cadastrarUsuario.
        <pre><code class="lang-js">usuario.novo = new Usuario(dadosUsuario);</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 10</span>: Iremos agora gerar as
        credenciais a partir da senaha informada em dadosUsuario, fazemos isso
        porque não é uma boa prática de segurança armazenar a senha informada
        pelo usuário em um banco de dados, então geraremos um salt e um hash
        para essa senha.
        <pre><code class="lang-js"></code>const credenciais = gerarCredenciais(dadosUsuario.senha);</pre>
    </li>
    <li>
        <span class="lf-strong">Linha 11</span>: Armazenamos o salt gerado pela
        função gerarCredenciais no objeto do novo usuário. O salt é uma string
        gerada aleatóriamente que tem como papel se juntar à senha no momento de
        criptografar a palavra passe, dessa forma tornando a criptografia da
        hash mais difícil de se quebrar
        <pre><code class="lang-js">usuario.novo.salt = credenciais.salt;</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 12</span>: Armazenamos a hash gerada pela
        função gerarCredenciais no objeto do novo usuário. A hash é o valor
        gerado após criptografar a string da senha combinada com o salt. Por se
        tratar de um valor criptografado podemos salvar a hash no banco de dados
        por a partir dela é praticamente impossível chegar até a senha do
        usuário.
        <pre><code class="lang-js">usuario.novo.hash = credenciais.hash;</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 13 a 17</span>: Executamos a função
        gerarJWT no atributo usuario.token, essa função irá gerar um JSON Web
        Token autenticado pela aplicação. A função gerarJWT recebe em seus
        parâmetros o id do usuário, seu e-mail e seu nome, esses valores ficarão
        salvos no payload do JWT gerado, assim quando o cliente enviar esse
        token em outro ponto da API a aplicação terá ciência de qual usuário se
        trata.

        <pre><code class="lang-js"></code>usuario.token = gerarJWT(
            usuario.novo.id,
            usuario.novo.email,
            usuario.novo.nome
        );</pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 18 a 20</span>: Agora executamos o método
        usuario.novo.save() para salvar os dados do novo usuário como um
        documento no banco de dados e salvamos true no atributo
        usuario.cadastrado para informar que um novo usuário foi de fato salvo
        no banco. Fehamos o escopo do if.
        <pre><code class="lang-js">    usuario.novo.save();
            usuario.cadastrado = true;
        }</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 21</span>: Por fim retornamos o objeto
        usuário que foi criado anteriormente, ele terá os dados do novo usuário
        e cadastrado com true ou terá apenas cadastrado com false. Fechamos
        then() e fechamos cadastrarUsuario.
        <pre><code class="lang-js">        return usuario;
        });
    };</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 25</span>: Criamos a função logarUsuario
        que irá receber o email e a senha do usuário que prentende se logar e
        deverá retornar se o usuário foi autenticado junto com o JWT ou não.
        <pre><code class="lang-js">const logarUsuario = (email, senha) => {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 26</span>: Dentro da função iremos
        returnar o método Usuario.find() que retorna uma promise, em seu then
        passamos uma função callback que terá o usuário cadastrado em seu
        parâmetro.
        <pre><code class="lang-js">return Usuario.findOne({ email }).then(cadastrado => {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 27</span>: Criamos a constante usuario que
        armazena um objeto com o atributo autenticado igual a false. Esse objeto
        será o retorno da função cadastrarUsuario e irá informar quem a executou
        se o usuário passado foi autenticado ou não.
        <pre><code class="lang-js">const usuario = { autenticado: false };</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 28</span>: Para dar procedimento com a
        rotina de autenticação precisamos ter certeza que o usuário está
        cadastrado e que que sua senha está correta, então criamos um if que só
        irá executar seu bloco se cadastrado existir e se a função senhaConfere
        for true ao receber a senha e o objeto do usuário cadastrado.
        <pre><code class="lang-js">if (cadastrado && senhaConfere(senha, cadastrado)) {</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 29 a 33</span>: Executamos a função
        gerarJWT no atributo usuario.token, essa função irá gerar um JSON Web
        Token autenticado pela aplicação. A função gerarJWT recebe em seus
        parâmetros o id do usuário, seu e-mail e seu nome, esses valores ficarão
        salvos no payload do JWT gerado, assim quando o cliente enviar esse
        token em outro ponto da API a aplicação terá ciência de qual usuário se
        trata.
        <pre><code class="lang-js">usuario.token = gerarJWT(
            cadastrado.id,
            cadastrado.email,
            cadastrado.nome
        );</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 34</span>: Aalvamos true no atributo
        usuario.autenticado para informar que um novo usuário foi de fato salvo
        no banco. Fehamos o escopo do if.
        <pre><code class="lang-js">    usuario.autenticado = true;
        }</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linhas 36 a 38</span>:
        <pre><code class="lang-js">        return usuario;
        });
    };</code></pre>
    </li>
    <li>
        <span class="lf-strong"></span>
        <pre><code class="lang-js">Por fim retornamos o objeto
            usuário que foi criado anteriormente, ele terá os dados do novo usuário
            e cadastrado com true ou terá apenas cadastrado com false. Fechamos
            then() e fechamos logarUsuario.</code></pre>
    </li>
    <li>
        <span class="lf-strong">Linha 40</span>: Por fim exportamos as funções
        criadas nesse módulo para que possams ser acessadas por outras partes da
        aplicação
        <pre><code class="lang-js">module.exports = { cadastrarUsuario, logarUsuario };</code></pre>
    </li>
</ul>
